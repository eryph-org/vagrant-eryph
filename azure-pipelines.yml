# Triggers
trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - '*.md'

pr:
  branches:
    include:
    - main

pool:
  name: eryph
  demands:
  - Agent.Name -equals vsts-agent

variables:
  RUBY_VERSION: '3.4'
  BUNDLER_VERSION: '2.4.10'
  RUBY_PATH: 'C:\Ruby34-x64\bin'

stages:
# Stage 1: Build and Test
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: TestAndBuild
    displayName: 'Test Vagrant Plugin and Build Gem'

    steps:
    # Update RubyGems and install Bundler
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        gem update --system --no-document
        gem install bundler -v $(BUNDLER_VERSION) --no-document
      displayName: 'Update RubyGems and install Bundler'

    # Install dependencies
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        bundle install --jobs 4 --retry 3
      displayName: 'Bundle install'

    # Run unit tests
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        bundle exec rake unit:ci
      displayName: 'Run unit tests'
      continueOnError: true

    # Run E2E tests (assuming Vagrant and Eryph are available)
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        bundle exec rake e2e:ci
      displayName: 'Run E2E tests'
      continueOnError: true

    # Build gem
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        bundle exec rake build
      displayName: 'Build vagrant-eryph gem'

    # Create artifacts directory and copy gem
    - script: |
        mkdir $(Build.ArtifactStagingDirectory)\gems
        copy vagrant-eryph-*.gem $(Build.ArtifactStagingDirectory)\gems\
      displayName: 'Prepare gem artifacts'

    # Publish test results
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'test-results-*.xml'
        failTaskOnFailedTests: true
        testRunTitle: 'Vagrant Eryph Plugin Tests'
      displayName: 'Publish test results'
      condition: always()

    # Publish gem artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)\gems'
        artifactName: 'vagrant-eryph-gem'
        artifactType: 'container'
      displayName: 'Publish gem artifacts'
      condition: succeeded()

    # Display build summary
    - script: |
        set PATH=$(RUBY_PATH);%PATH%
        echo "=== Build Summary ==="
        ruby --version
        bundle --version
        echo "Built gems:"
        dir vagrant-eryph-*.gem
        echo "=== End Summary ==="
      displayName: 'Build summary'
      condition: always()